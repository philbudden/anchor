---
# Main provisioning playbook (entrypoint).
# Orchestrates all roles for host provisioning and service deployment.
#
# Default behavior (safe):
# - Provision host (Homebrew, Ollama, Docker Desktop, OpenWebUI)
# - Ensure declared models are present (do not repull or prune by default)
# - No upgrades, no model pruning
#
# Usage:
#   ansible-playbook playbooks/site.yml                  # Default safe run
#   ansible-playbook playbooks/site.yml --check          # Dry-run
#   ansible-playbook playbooks/site.yml -e enable_upgrades=true  # With upgrades
#   ansible-playbook playbooks/site.yml --tags preflight # Run preflight checks only
#   ansible-playbook playbooks/site.yml --tags smoke     # Non-destructive smoke test
#   ansible-playbook playbooks/verify.yml               # Run connectivity verification
#
# Available tags:
#   preflight        - System checks and assertions (safe, read-only)
#   brew             - Homebrew installation and packages
#   ollama           - Ollama installation and service
#   docker_desktop   - Docker Desktop installation
#   models           - Ollama model management
#   openwebui        - OpenWebUI container deployment
#   smoke            - Non-destructive subset for CI testing
#
# See docs/ for upgrade procedures and troubleshooting.

- name: "Provision local LLM server"
  hosts: macmini
  gather_facts: true

  pre_tasks:
    - name: "Display provisioning mode"
      ansible.builtin.debug:
        msg: |
          Provisioning mode:
            enable_upgrades: {{ enable_upgrades }}
            ollama_models_refresh: {{ ollama_models_refresh }}
            ollama_models_prune: {{ ollama_models_prune }}

          Data directory: {{ local_llm_data_dir }}
          Declared models: {{ ollama_models | length }}
      tags: [always]

    - name: "Assert running on macOS (Darwin)"
      ansible.builtin.assert:
        that:
          - ansible_system == "Darwin"
        fail_msg: "This playbook is designed for macOS only. Detected: {{ ansible_system }}"
        success_msg: "Running on macOS ({{ ansible_distribution }} {{ ansible_distribution_version }})"
      tags: [preflight, always]

  roles:
    - role: common
      tags: [always, preflight]
    - role: homebrew
      tags: [brew]
    - role: ollama
      tags: [ollama]
    - role: docker_desktop
      tags: [docker_desktop]
    - role: models
      tags: [models]
    - role: openwebui
      tags: [openwebui]

  post_tasks:
    - name: "Provisioning complete"
      ansible.builtin.debug:
        msg: |
          Provisioning complete.
          Next steps:
            1. Verify connectivity: ansible-playbook playbooks/verify.yml
            2. Review health checks in docs/
            3. Configure access as needed
      tags: [always]
