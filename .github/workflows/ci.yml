---
# CI workflow for Ansible playbook validation on Linux
# This workflow provides fast feedback without requiring macOS runners
#
# What this tests:
# - YAML formatting (yamllint)
# - Ansible syntax (ansible-playbook --syntax-check)
# - Ansible best practices (ansible-lint)
# - Custom structural validation (Python scripts)
# - Model declaration validity
# - Darwin guard checks
# - Idempotency patterns
#
# What this does NOT test:
# - Actual execution on macOS (see macos-integration.yml for that)
# - Homebrew, Ollama, Docker Desktop installation
# - Model downloads
# - Service deployment
#
# Trade-offs:
# - Fast feedback (runs in <2 minutes)
# - No macOS runner costs
# - Catches 80%+ of issues before macOS integration
# - Some false positives possible in structural checks

name: CI - Validation (Linux)

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  lint-yaml:
    name: YAML Formatting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install yamllint
        run: |
          pip install yamllint==1.35.1

      - name: Run yamllint
        run: |
          yamllint --version
          yamllint .

  ansible-syntax:
    name: Ansible Syntax Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Ansible
        run: |
          pip install ansible-core==2.17.0

      - name: Install Ansible collections
        run: |
          ansible-galaxy collection install -r requirements.yml

      - name: Run syntax check on all playbooks
        run: |
          ansible-playbook --version
          ansible-playbook --syntax-check playbooks/site.yml
          ansible-playbook --syntax-check playbooks/verify.yml
          ansible-playbook --syntax-check playbooks/preflight.yml

  ansible-lint:
    name: Ansible Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Install Ansible collections
        run: |
          ansible-galaxy collection install -r requirements.yml

      - name: Run ansible-lint
        run: |
          ansible-lint --version
          ansible-lint playbooks/ roles/

  validate-structure:
    name: Validate Role Structure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run structure validation
        run: |
          python3 scripts/validate_structure.py

  validate-models:
    name: Validate Model Declarations
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PyYAML
        run: |
          pip install PyYAML==6.0.1

      - name: Run model validation
        run: |
          python3 scripts/validate_models.py

  check-darwin-guards:
    name: Check Darwin Guards
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PyYAML
        run: |
          pip install PyYAML==6.0.1

      - name: Check for unguarded macOS tasks
        run: |
          python3 scripts/check_darwin_guards.py

  check-idempotency:
    name: Check Idempotency Patterns
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PyYAML
        run: |
          pip install PyYAML==6.0.1

      - name: Check idempotency patterns
        run: |
          python3 scripts/validate_idempotency.py

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs:
      - lint-yaml
      - ansible-syntax
      - ansible-lint
      - validate-structure
      - validate-models
      - check-darwin-guards
      - check-idempotency
    if: always()
    steps:
      - name: Check all jobs status
        run: |
          echo "All validation jobs completed"
          echo "Results:"
          echo "  YAML Lint: ${{ needs.lint-yaml.result }}"
          echo "  Ansible Syntax: ${{ needs.ansible-syntax.result }}"
          echo "  Ansible Lint: ${{ needs.ansible-lint.result }}"
          echo "  Structure Validation: ${{ needs.validate-structure.result }}"
          echo "  Model Validation: ${{ needs.validate-models.result }}"
          echo "  Darwin Guards: ${{ needs.check-darwin-guards.result }}"
          echo "  Idempotency: ${{ needs.check-idempotency.result }}"

      - name: Fail if any job failed
        if: |
          needs.lint-yaml.result == 'failure' ||
          needs.ansible-syntax.result == 'failure' ||
          needs.ansible-lint.result == 'failure' ||
          needs.validate-structure.result == 'failure' ||
          needs.validate-models.result == 'failure' ||
          needs.check-darwin-guards.result == 'failure' ||
          needs.check-idempotency.result == 'failure'
        run: |
          echo "One or more validation jobs failed"
          exit 1
