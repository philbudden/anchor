---
# macOS Integration Testing (Optional)
# This workflow runs on actual macOS runners for integration validation
#
# Triggers:
# - Manual via workflow_dispatch
# - Weekly schedule (optional - adjust as needed)
#
# What this tests:
# - Playbook runs on actual macOS (in check mode)
# - Fact gathering works
# - Task execution order
# - Darwin-specific logic
#
# What this does NOT test:
# - Actual installation (check mode only - safe, non-destructive)
# - Service deployment
# - Model downloads
#
# Limitations:
# - GitHub-hosted macOS runners are clean VMs
# - Some tasks may fail in check mode (expected)
# - This validates structure, not full provisioning
# - Full provisioning would require dedicated runner or manual testing
#
# Trade-offs:
# - Uses macOS runner minutes (costs money)
# - Slower than Linux CI (~5-10 minutes)
# - Provides higher confidence for macOS-specific logic
# - Should be run before releases or on demand

name: macOS Integration (Optional)

on:
  # Manual trigger only by default
  workflow_dispatch:
    inputs:
      run_full_check:
        description: 'Run full playbook in check mode'
        required: false
        type: boolean
        default: true

  # Optional: uncomment to run weekly
  # schedule:
  #   - cron: '0 0 * * 0'  # Every Sunday at midnight UTC

jobs:
  macos-check-mode:
    name: macOS Check Mode Validation
    runs-on: macos-14  # macOS Sonoma (Apple Silicon)

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Ansible and dependencies
        run: |
          pip install -r requirements.txt
          ansible --version

      - name: Display macOS info
        run: |
          sw_vers
          uname -a
          echo "Architecture: $(uname -m)"

      - name: Set up local inventory for testing
        run: |
          mkdir -p inventory_test
          cat > inventory_test/hosts.yml <<EOF
          ---
          all:
            hosts:
              localhost:
                ansible_connection: local
                ansible_python_interpreter: /usr/bin/python3

          macmini:
            hosts:
              localhost:
          EOF

      - name: Test verify playbook (read-only, should work)
        run: |
          ansible-playbook \
            -i inventory_test/hosts.yml \
            playbooks/verify.yml \
            -e local_llm_data_dir=/tmp/local-llm-test \
            -e ollama_models_dir=/tmp/local-llm-test/ollama/models \
            -e openwebui_data_dir=/tmp/local-llm-test/openwebui
        continue-on-error: true  # May fail if directories don't exist

      - name: Create test data directory
        run: |
          mkdir -p /tmp/local-llm-test/ollama/models
          mkdir -p /tmp/local-llm-test/openwebui

      - name: Test verify playbook again (with directories)
        run: |
          ansible-playbook \
            -i inventory_test/hosts.yml \
            playbooks/verify.yml \
            -e local_llm_data_dir=/tmp/local-llm-test \
            -e ollama_models_dir=/tmp/local-llm-test/ollama/models \
            -e openwebui_data_dir=/tmp/local-llm-test/openwebui

      - name: Run site playbook in check mode
        if: github.event.inputs.run_full_check != 'false'
        run: |
          ansible-playbook \
            -i inventory_test/hosts.yml \
            playbooks/site.yml \
            --check \
            -e local_llm_data_dir=/tmp/local-llm-test \
            -e ollama_models_dir=/tmp/local-llm-test/ollama/models \
            -e openwebui_data_dir=/tmp/local-llm-test/openwebui
        continue-on-error: true  # Expected: some tasks fail in check mode

      - name: Check Ansible facts
        run: |
          ansible \
            -i inventory_test/hosts.yml \
            localhost \
            -m ansible.builtin.setup \
            -a 'filter=ansible_system,ansible_os_family,ansible_distribution'

      - name: Cleanup
        if: always()
        run: |
          rm -rf /tmp/local-llm-test
          rm -rf inventory_test

  macos-summary:
    name: macOS Integration Summary
    runs-on: ubuntu-latest
    needs: [macos-check-mode]
    if: always()
    steps:
      - name: Report results
        run: |
          echo "macOS integration testing completed"
          echo "Check mode result: ${{ needs.macos-check-mode.result }}"
          echo ""
          echo "Note: This workflow validates macOS compatibility"
          echo "Full provisioning requires a dedicated Mac mini target"
