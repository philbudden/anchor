---
# Homebrew installation and configuration
# Idempotent: safe to re-run; detects existing installation

- name: "Check if Homebrew is already installed"
  ansible.builtin.stat:
    path: "{{ homebrew_prefix }}/bin/brew"
  register: homebrew_bin
  when: ansible_system == "Darwin"

- name: "Install Homebrew (if not present)"
  ansible.builtin.shell: |
    set -e
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  args:
    creates: "{{ homebrew_prefix }}/bin/brew"
  environment:
    NONINTERACTIVE: "1"
  when:
    - ansible_system == "Darwin"
    - not homebrew_bin.stat.exists

- name: "Ensure Homebrew is in PATH for this session"
  ansible.builtin.set_fact:
    ansible_env: "{{ ansible_env | combine({'PATH': homebrew_prefix ~ '/bin:' ~ ansible_env.PATH}) }}"
  when: ansible_system == "Darwin"

- name: "Verify Homebrew installation"
  ansible.builtin.command: "{{ homebrew_prefix }}/bin/brew --version"
  register: brew_version
  changed_when: false
  when: ansible_system == "Darwin"

- name: "Display Homebrew version"
  ansible.builtin.debug:
    msg: "Homebrew version: {{ brew_version.stdout_lines[0] }}"
  when:
    - ansible_system == "Darwin"
    - brew_version is defined
    - brew_version is not skipped
    - brew_version.stdout_lines is defined
    - brew_version.stdout_lines | length > 0

- name: "Update Homebrew (if upgrades enabled)"
  community.general.homebrew:
    update_homebrew: true
  when:
    - ansible_system == "Darwin"
    - homebrew_upgrade | bool

- name: "Install additional Homebrew packages"
  community.general.homebrew:
    name: "{{ item }}"
    state: present
  loop: "{{ homebrew_packages }}"
  when:
    - ansible_system == "Darwin"
    - homebrew_packages | length > 0
